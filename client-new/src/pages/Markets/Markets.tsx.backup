import { useMemo, useState } from 'react';
import { BVC_STOCKS } from '../../data/bvc-tradingview-mapping';
import StockChartModal from '../../components/charts/StockChartModal';

const markets = BVC_STOCKS;

const sectors = [
  { name: 'Banques', change: 0.72 },
  { name: 'Télécom', change: -0.12 },
  { name: 'Immobilier', change: 0.34 },
  { name: 'Distribution', change: 0.18 },
  { name: 'Énergie', change: 1.12 },
];

const formatChange = (value: number) => `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;

export const Markets = () => {
  const [query, setQuery] = useState('');
  const [sectorFilter, setSectorFilter] = useState<string | null>(null);
  const [selectedStock, setSelectedStock] = useState<null | { ticker: string; name: string; symbol: string }>(null);

  const sectors = useMemo(() => Array.from(new Set(BVC_STOCKS.map((s) => s.sector))).slice(0, 10), []);

  const filtered = useMemo(() => {
    return markets.filter((m) => {
      const matchesQuery = query.trim() === '' || m.name.toLowerCase().includes(query.toLowerCase()) || m.ticker.toLowerCase().includes(query.toLowerCase()) || m.tradingViewSymbol.toLowerCase().includes(query.toLowerCase());
      const matchesSector = !sectorFilter || m.sector === sectorFilter;
      return matchesQuery && matchesSector;
    });
  }, [markets, query, sectorFilter]);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <p className="text-sm uppercase tracking-[0.2em] text-primary/70 font-semibold">Marchés</p>
          <h1 className="text-3xl font-bold font-display">Actions BVC</h1>
          <p className="text-base-content/70">Vue type investing.com : watchlist, movers, secteur.</p>
        </div>
        <div className="join">
          <button className="btn btn-ghost btn-sm join-item">Tous</button>
          <button className="btn btn-ghost btn-sm join-item">Gainers</button>
          <button className="btn btn-ghost btn-sm join-item">Losers</button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 glass rounded-2xl p-4 border border-white/5">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="font-semibold">Toutes les actions BVC</h3>
              <span className="text-xs text-base-content/60">Cliquez sur une ligne pour ouvrir le graphique</span>
            </div>
            <div className="flex items-center gap-2">
              <input className="input input-sm" placeholder="Rechercher par nom / ticker" value={query} onChange={(e) => setQuery(e.target.value)} />
              <select className="select select-sm" value={sectorFilter ?? ''} onChange={(e) => setSectorFilter(e.target.value || null)}>
                <option value="">Tous les secteurs</option>
                {sectors.map((s) => (<option key={s} value={s}>{s}</option>))}
              </select>
            </div>
          </div>
          <div className="overflow-x-auto">
            <table className="table table-sm">
              <thead>
                <tr>
                  <th>Symbole</th>
                  <th>Nom</th>
                  <th className="text-right">Dernier</th>
                  <th className="text-right">Var%</th>
                  <th className="text-right">Volume</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((m) => {
                  const displayTicker = m.tradingViewSymbol.split(':')[1] || m.ticker;
                  return (
                    <tr key={m.tradingViewSymbol} className="hover cursor-pointer" onClick={() => setSelectedStock({ ticker: displayTicker, name: m.name, symbol: m.tradingViewSymbol })}>
                      <td className="font-semibold">{displayTicker}</td>
                      <td>{m.name}</td>
                      <td className="text-right text-mono font-semibold">-</td>
                      <td className={`text-right font-semibold text-base-content/60`}>-</td>
                      <td className="text-right text-base-content/70">-</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>

        <div className="space-y-4">
          <div className="glass rounded-2xl p-4 border border-white/5">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold">Vue secteur</h3>
              <span className="text-xs text-base-content/60">Heatmap</span>
            </div>
            <div className="space-y-2">
              {sectors.map((s) => {
                const positive = s.change >= 0;
                const color = positive ? 'text-success' : 'text-error';
                return (
                  <div key={s.name} className="flex items-center justify-between p-2 rounded-lg bg-base-300/50">
                    <div className="font-semibold">{s.name}</div>
                    <div className={`text-sm ${color}`}>{formatChange(s.change)}</div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="glass rounded-2xl p-4 border border-white/5">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold">Moteurs du marché</h3>
              <span className="text-xs text-base-content/60">Gainers/Losers</span>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div className="space-y-2">
                {markets
                  .filter((m) => m.change > 0)
                  .slice(0, 2)
                  .map((m) => (
                    <div key={m.symbol} className="p-2 rounded-lg bg-success/10 border border-success/20">
                      <div className="font-semibold">{m.symbol}</div>
                      <div className="text-xs text-base-content/60">{m.name}</div>
                      <div className="text-success text-sm">{formatChange(m.change)}</div>
                    </div>
                  ))}
              </div>
              <div className="space-y-2">
                {markets
                  .filter((m) => m.change < 0)
                  .slice(0, 2)
                  .map((m) => (
                    <div key={m.symbol} className="p-2 rounded-lg bg-error/10 border border-error/20">
                      <div className="font-semibold">{m.symbol}</div>
                      <div className="text-xs text-base-content/60">{m.name}</div>
                      <div className="text-error text-sm">{formatChange(m.change)}</div>
                    </div>
                  ))}
              </div>
            </div>
          </div>
        </div>
      </div>
      {selectedStock && (
        <StockChartModal
          isOpen={!!selectedStock}
          onClose={() => setSelectedStock(null)}
          ticker={selectedStock.ticker}
          stockName={selectedStock.name}
          tradingViewSymbol={selectedStock.symbol}
        />
      )}
    </div>
  );
};
